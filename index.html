<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSL 憑證檢查產生器 (含使用說明)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; }
        .main-container { max-width: 1100px; margin: 30px auto; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { border-radius: 12px 12px 0 0 !important; font-weight: 600; padding: 15px 20px; }
        .code-preview { background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 13px; height: 350px; overflow-y: auto; }
        .guide-section h5 { color: #0d6efd; font-weight: 700; margin-top: 15px; }
        .guide-section code { color: #d63384; background-color: #f8f9fa; padding: 2px 5px; border-radius: 4px; border: 1px solid #e9ecef; }
        .step-badge { background-color: #0d6efd; color: white; padding: 2px 8px; border-radius: 50%; font-size: 0.8em; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container main-container">
    
    <!-- 標題區 -->
    <div class="text-center mb-5">
        <h1 class="fw-bold"><i class="bi bi-shield-check text-primary"></i> SSL 憑證檢查工具產生器</h1>
        <p class="text-muted">生成 PowerShell 腳本，透過 Outlook 發送憑證到期警告 (EML 檔案法)</p>
    </div>

    <div class="row">
        <!-- 左側：設定區 -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white"><i class="bi bi-sliders"></i> 1. 參數設定</div>
                <div class="card-body">
                    <form id="generatorForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">監控網域列表</label>
                            <textarea class="form-control" id="domains" rows="8" placeholder="一行一個網址，例如：&#10;www.google.com&#10;esvc.fnp.gov.tw"></textarea>
                            <div class="form-text">請輸入網址，不需加 https://</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">通知 Email</label>
                            <input type="email" class="form-control" id="email" placeholder="name@company.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">警告天數</label>
                            <div class="input-group">
                                <span class="input-group-text">剩餘</span>
                                <input type="number" class="form-control" id="daysWarn" value="30">
                                <span class="input-group-text">天內警告</span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary w-100 py-2" onclick="generateScript()">
                            <i class="bi bi-lightning-fill"></i> 產生腳本
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 右側：預覽與下載 -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-code-slash"></i> 2. 腳本預覽</span>
                    <button class="btn btn-sm btn-outline-light" onclick="copyToClipboard()">複製代碼</button>
                </div>
                <div class="card-body p-0">
                    <pre class="code-preview m-0" id="scriptPreview"># 請先在左側輸入資料，並點擊「產生腳本」...</pre>
                </div>
                <div class="card-footer bg-white p-3">
                    <div class="row g-2">
                        <div class="col-md-8">
                            <button class="btn btn-success w-100" onclick="downloadScript()" id="downloadBtn" disabled>
                                <i class="bi bi-download"></i> 下載腳本 (.ps1)
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-secondary w-100" onclick="downloadBat()" id="downloadBatBtn" disabled>
                                <i class="bi bi-filetype-exe"></i> 下載啟動檔 (.bat)
                            </button>
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block text-center">* 建議同時下載兩個檔案，放在同一個資料夾中。</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 下方：使用說明書 -->
    <div class="card mt-4 guide-section">
        <div class="card-header bg-info text-dark bg-opacity-25 border-info">
            <i class="bi bi-book-fill"></i> 使用說明書
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="bi bi-pc-display"></i> 環境需求</h5>
                    <ul>
                        <li>作業系統：Windows 10 / 11 / Server</li>
                        <li>必要軟體：<strong>Microsoft Outlook</strong> (需已登入帳號)</li>
                        <li>網路：執行時電腦必須能連上網際網路</li>
                    </ul>

                    <h5><i class="bi bi-play-circle-fill"></i> 如何執行 (推薦)</h5>
                    <ol>
                        <li>點擊上方的按鈕，下載 <code>check_ssl.ps1</code> 和 <code>開始檢查.bat</code>。</li>
                        <li>將兩個檔案放在<strong>同一個資料夾</strong>內 (例如 D:\chkSSL)。</li>
                        <li>直接雙擊 <code>開始檢查.bat</code> 即可執行。</li>
                        <li>若有憑證快過期，Outlook 視窗會自動彈出；若全數正常則視窗會自動關閉。</li>
                    </ol>
                </div>
                <div class="col-md-6">
                    <h5><i class="bi bi-exclamation-triangle-fill"></i> 常見問題排除</h5>
                    <p>如果是第一次執行，可能會出現紅字錯誤 (禁止執行指令碼)。請依照以下步驟開啟權限：</p>
                    <div class="alert alert-secondary py-2">
                        <small>1. 按 <kbd>Win</kbd> + <kbd>X</kbd>，選擇「Windows PowerShell (系統管理員)」。<br>
                        2. 複製貼上以下指令並按 Enter：</small><br>
                        <code class="user-select-all">Set-ExecutionPolicy RemoteSigned -Scope CurrentUser</code><br>
                        <small>3. 出現詢問時，輸入 <code>Y</code> 並按 Enter。</small>
                    </div>
                    
                    <h5><i class="bi bi-clock-history"></i> 如何設定每日自動檢查？</h5>
                    <p class="small text-muted mb-0">
                        開啟 Windows「工作排程器」→ 建立基本工作 → 觸發程序選「每天」→ 動作選「啟動程式」。<br>
                        程式輸入：<code>powershell.exe</code><br>
                        引數輸入：<code>-WindowStyle Hidden -ExecutionPolicy Bypass -File "您的路徑\check_ssl.ps1"</code>
                    </p>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // 預設值
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('domains').value = "esvc.fnp.gov.tw\nwww.fnp.gov.tw\nwebjop.fnp.gov.tw/J2Appendix\npts.fnp.gov.tw/APNPA\npms.fnp.gov.tw\niesextmail1.fnp.gov.tw";
        document.getElementById('email').value = "wencheng.tw@gmail.com";
    });

    function generateScript() {
        const domains = document.getElementById('domains').value.trim().split('\n').filter(d => d.trim() !== '');
        let email = document.getElementById('email').value.trim();
        const daysWarn = document.getElementById('daysWarn').value.trim();

        if (domains.length === 0) { alert('請輸入網域'); return; }
        if (email === "") email = "請輸入收件人@example.com";

        let domainList = domains.map(d => `"${d.trim()}"`).join(', ');

        // 這是最終確認可用的 EML 版本腳本
        let script = `# SSL Checker (EML Method) - Generated on ${new Date().toLocaleDateString()}
$domains = @(${domainList})
$notifyEmail = "${email}"
$warningDays = ${daysWarn}
$reportPath = "$PSScriptRoot\\SSL_Report.html"
$csvPath = "$PSScriptRoot\\SSL_Report.csv"
$emlPath = "$PSScriptRoot\\SSL_Alert.eml"

$results = @()
$needsAlert = $false

Write-Host "正在檢查 SSL 憑證，請稍候..." -ForegroundColor Cyan

# --- 檢查邏輯 ---
foreach ($domain in $domains) {
    Write-Host "檢查: $domain ..." -NoNewline
    try {
        $url = "https://$domain"
        $req = [Net.HttpWebRequest]::Create($url)
        $req.Timeout = 5000
        $req.GetResponse().Dispose()
        $cert2 = [System.Security.Cryptography.X509Certificates.X509Certificate2]$req.ServicePoint.Certificate
        
        $daysLeft = ($cert2.NotAfter - (Get-Date)).Days
        $status = if ($daysLeft -le $warningDays) { "WARNING" } else { "OK" }
        $color = if ($status -eq "WARNING") { "Red" } else { "Green" }
        if ($status -eq "WARNING") { $needsAlert = $true }
        
        Write-Host " [剩餘 $daysLeft 天]" -ForegroundColor $color
        
        $results += [PSCustomObject]@{ Domain=$domain; Expiry=$cert2.NotAfter.ToString("yyyy-MM-dd"); Days=$daysLeft; Status=$status; Issuer=$cert2.Issuer }
    }
    catch {
        Write-Host " [連線失敗]" -ForegroundColor Red
        $needsAlert = $true
        $results += [PSCustomObject]@{ Domain=$domain; Expiry="N/A"; Days=0; Status="ERROR"; Issuer="Error" }
    }
}

# --- 產生 HTML 表格內容 ---
$results | Export-Csv -Path $csvPath -NoTypeInformation -Encoding UTF8
$tableRows = $results | ForEach-Object {
    $bg = if($_.Status -eq 'WARNING'){'#fff3cd'}elseif($_.Status -eq 'ERROR'){'#f8d7da'}else{'#ffffff'}
    "<tr style='background-color:$bg'><td>$($_.Domain)</td><td>$($_.Expiry)</td><td>$($_.Days)</td><td>$($_.Status)</td></tr>"
}

$mailBody = @"
<html>
<body style="font-family: Arial, sans-serif;">
    <h3 style="color: #d9534f;">⚠️ SSL 憑證異常通知</h3>
    <p>系統檢測到以下網域憑證即將到期或連線失敗，請儘速處理：</p>
    <table border="1" cellpadding="5" style="border-collapse: collapse; width: 100%; border: 1px solid #ddd;">
        <tr style="background-color: #f2f2f2;"><th>網域</th><th>到期日</th><th>剩餘天數</th><th>狀態</th></tr>
        $tableRows
    </table>
    <p><small>此郵件由 PowerShell 系統自動產生。</small></p>
</body>
</html>
"@

# 存檔報告
$mailBody | Out-File -FilePath $reportPath -Encoding UTF8

# --- 通知邏輯 (EML 檔案法) ---
if ($needsAlert) {
    Write-Host "\`n[!] 發現異常，準備產生郵件..." -ForegroundColor Yellow
    
    $emlContent = @"
To: $notifyEmail
Subject: [SSL警告] 憑證異常報告
X-Unsent: 1
Content-Type: text/html; charset=utf-8

$mailBody
"@

    $emlContent | Out-File -FilePath $emlPath -Encoding UTF8
    
    Write-Host "正在啟動 Outlook..." -ForegroundColor Cyan
    try {
        Invoke-Item $emlPath
        Write-Host "已開啟郵件視窗！請檢查後傳送。" -ForegroundColor Green
    }
    catch {
        Write-Host "開啟失敗。請手動雙擊資料夾中的 SSL_Alert.eml" -ForegroundColor Red
    }
} else {
    Write-Host "檢查正常，無須通知。" -ForegroundColor Green
}
Write-Host "5 秒後自動關閉..."
Start-Sleep -Seconds 5
`;
        document.getElementById('scriptPreview').textContent = script;
        document.getElementById('downloadBtn').disabled = false;
        document.getElementById('downloadBatBtn').disabled = false;
        alert('腳本已產生！\n\n建議同時下載 .ps1 與 .bat 檔案，\n並參考下方的使用說明書進行操作。');
    }

    function copyToClipboard() {
        navigator.clipboard.writeText(document.getElementById('scriptPreview').textContent);
        alert('代碼已複製到剪貼簿');
    }

    function downloadScript() {
        downloadFile('check_ssl.ps1', document.getElementById('scriptPreview').textContent);
    }

    function downloadBat() {
        const batContent = `@echo off
echo 正在啟動 SSL 檢查腳本...
PowerShell -NoProfile -ExecutionPolicy Bypass -File "%~dp0check_ssl.ps1"
`;
        downloadFile('開始檢查.bat', batContent);
    }

    function downloadFile(filename, content) {
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), content], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>
